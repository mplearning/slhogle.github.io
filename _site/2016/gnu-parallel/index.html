<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> GNU Parallel for mutlithreaded tasks | Notes </title> <meta name="description" content=" Microbes + Biogeochemistry "> <meta name="keywords" content="Marine, microbial ecology, bacteria, biogeochemistry, ocean"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Shane Hogle"> <meta property="article:section" content=""> <meta property="article:tag" content=""> <meta property="article:published_time" content="2016-12-03 00:00:00 +0200"> <meta property="og:url" content="http://slhogle.github.io/2016/gnu-parallel/"> <meta property="og:title" content=" GNU Parallel for mutlithreaded tasks | Notes "> <meta property="og:image" content="http://slhogle.github.io"> <meta property="og:description" content=" Microbes + Biogeochemistry "> <meta property="og:site_name" content="Shane Hogle"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@slhogle"> <meta name="twitter:title" content=" GNU Parallel for mutlithreaded tasks | Notes "> <meta name="twitter:description" content=" Microbes + Biogeochemistry "> <meta name="twitter:image:src" content="http://slhogle.github.io"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" GNU Parallel for mutlithreaded tasks | Notes "> <meta itemprop="description" content=" Microbes + Biogeochemistry "> <meta itemprop="image" content="http://slhogle.github.io"> <!-- rel prev and next --> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="/assets/css/font-awesome.min.css"> <!-- Canonical link tag --> <link rel="canonical" href="http://slhogle.github.io/2016/gnu-parallel/"> <link rel="alternate" type="application/rss+xml" title="Notes" href="http://slhogle.github.io/feed.xml"> <script type="text/javascript"> var disqus_shortname = 'slhogle-site'; var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-XXXXX-XX']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="/">Notes<span></span></a></h1> <ul class="navbar"> <li><a href="/about">about</a></li> <li><a href="/research">research</a></li> <li><a href="/publications">publications</a></li> <li><a href="/biographical_sketch">biographical sketch</a></li> <li><a href="/contact">contact</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2016-12-03T00:00:00+02:00" itemprop="datePublished">Dec 3, 2016</time></p> <h1 class="post-title" itemprop="name headline">GNU Parallel for mutlithreaded tasks</h1> </header> <div class="post-content" itemprop="articleBody"> <p>We’re sequencing a bunch of single cell bacterial genomes, and I had like a 1000 genomes we needed to quickly call ORFs on and annotate. I’m using the excellent <a href="https://github.com/tseemann/prokka">Prokka</a> software, but I wanted to parallelize it with GNU Parallel. I ended up putting together this series of scripts (based off instructions <a href="https://rcc.uchicago.edu/documentation/_build/html/running-jobs/srun-parallel/index.html#parallel-batch">here</a>) to eventually make it work with our SLURM scheduler. If you know a better way to do this lemme know!</p> <p>While I’m at it some useful links for GNU Parallel</p> <ul> <li><a href="https://www.biostars.org/p/63816/">Quick tutorial on Biostars</a></li> <li><a href="https://www.gnu.org/software/parallel/parallel_tutorial.html">Official GNU tutorial</a></li> <li><a href="https://rcc.uchicago.edu/documentation/_build/html/tutorials/kicp-tutorials/running-jobs.html">GNU Parallel and SLURM from U Chicago</a></li> <li><a href="http://outreach.ino.pm/presentations/2014/03/genomics-wranglers/index.html#/18">A nice presentation</a> by Ino de Bruijn</li> </ul> <h3 id="prokkahetssh">prokka.hets.sh</h3> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nv">odir</span><span class="o">=</span><span class="s1">'OUTPATH'</span>
<span class="nv">rawnucl</span><span class="o">=</span><span class="s1">'SCAFFOLD_LOCATION'</span>

<span class="nv">qpath</span><span class="o">=</span><span class="k">$(</span>find <span class="k">${</span><span class="nv">rawnucl</span><span class="k">}</span> -name <span class="k">${</span><span class="nv">1</span><span class="k">}</span>.fna<span class="k">)</span>

prokka <span class="se">\</span>
--addgenes <span class="se">\</span>
--kingdom Bacteria <span class="se">\</span>
--outdir <span class="k">${</span><span class="nv">odir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="se">\</span>
--genus Marine_Heterotroph <span class="se">\</span>
--species <span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="se">\</span>
--locustag <span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="se">\</span>
--prefix <span class="k">${</span><span class="nv">1</span><span class="k">}</span> <span class="se">\</span>
--cpus 20 <span class="k">${</span><span class="nv">qpath</span><span class="k">}</span></code></pre></figure> <p>prokka.hets.sh is the shell script that will be parallelized. The cool thing is that you can run multi-threaded tasks using this techniqe. For example I’m running Prokka using 20 cores per job. GNU Parallel can cleverly handle available resources such that multi-threaded tasks can be parallelized across multiple nodes. More on that below…</p> <p><em>Of note: $1 is arg1:{1} from parallel.</em></p> <h3 id="parallelsh">parallel.sh</h3> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="c">#SBATCH --time=04:00:00</span>
<span class="c">#SBATCH --nodes=10</span>
<span class="c">#SBATCH --ntasks-per-node=1</span>
<span class="c">#SBATCH --cpus-per-task=20</span>
<span class="c">#SBATCH --exclusive</span>
<span class="c">#SBATCH -p MYQUEUE</span>

<span class="nv">srun</span><span class="o">=</span><span class="s2">"srun --exclusive -N1 -n1 -c</span><span class="nv">$SLURM_CPUS_PER_TASK</span><span class="s2">"</span>

<span class="nv">parallel</span><span class="o">=</span><span class="s2">"parallel --delay .2 -j </span><span class="nv">$SLURM_NNODES</span><span class="s2"> --joblog runtask.log --resume -a </span><span class="k">${</span><span class="nv">2</span><span class="k">}</span><span class="s2">"</span>

<span class="k">${</span><span class="nv">parallel</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">srun</span><span class="k">}</span><span class="s2"> ./</span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span></code></pre></figure> <p>Call this script as:</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash">sbatch parallel.sh prokka.hets.sh ids.txt</code></pre></figure> <p>Where prokka.hets.sh is the script above and ids.txt is a file containing ids (1 per line) of the nucleotide scaffolds that Prokka is to annotate. We use srun to execute the script prokka.hets.sh. The -c$SLURM_CPUS_PER_TASK instructs srun to allocate 20 CPUs to each instance of Prokka that runs. The –exclusive flag does not let Prokka share nodes with other running jobs and -N1 -n1 mandates that the 20 CPUs be dedicate to a single task (-n1) or a single instance of Prokka that is operating on a single node (-N1). These commands ensure that each Prokka task is confined to running on the 20 cpus residing on a single node.</p> <p>For the parallel command –delay .2 prevents overloading the controlling node, -j is the number of tasks parallel runs so but instead of $SLURM_NTASKS we want to use $SLURM_NNODES to tell parallel how many jobs to start. –joblog makes parallel create a log of tasks that it has already run and –resume makes parallel use the joblog to resume from where it has left off. The combination of –joblog and –resume allows jobs to be resubmitted if necessary and continue from where they left off. -a ids.txt is an option for parallel that allows it to use ids.txt as input source rather than arguments from the command line passed by ::: which is quite useful if your input doesn’t neatly follow some shell expansion or something…</p> <p>We finally run the parallel command and prokka.hets.sh should be able to use the 20 cpus per node that we requested with -c20 through srun.</p> <aside class="share"> <p>Share this post on <a href="http://twitter.com/share?text=GNU Parallel for mutlithreaded tasks&amp;url=http://slhogle.github.io/2016/gnu-parallel/&amp;via=slhogle" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">Twitter <i class="fa fa-twitter" aria-hidden="true" style="color:#00aced"></i></a> </p> </aside> </div> </article> <footer class="site-footer"> <div class="container"> <div align="center"> <small class="block">&copy; 2017 Shane Hogle. All rights reserved.</small> </div> </div> </footer> </main> </body> </html>
